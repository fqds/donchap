{% extends 'base.html' %}

{% block content %}

<style type="text/css">
    li {
        list-style-type: none;
    }
    ul {
        padding-left: 0;
    }
</style>

<div class="container-main mt-1 ms-1">
    <ul id="ul_master" style="display: flex;">
        <li style="padding-right: 20px;">
            <ul>
                {% for parameter in parameters %}
                <li>
                    {{ parameter.0 }}
                </li>
                {% endfor %}
            </ul>
        </li>
        {% for player in content %}
        <li>
            <ul>
                {% for parameter in player.0 %}
                <li>{{parameter}}⁣</li>
                {% endfor %}
            </ul>
            <ul>
                Инвентарь:
                {% for item in player.1 %}
                <li>
                    <div>{{item.0}}⁣</div>
                    <div>{{item.1}}⁣</div>
                    <ul>
                        {% for modifier in item.2 %}
                        <li>{{ modifier }}</li>
                        {% endfor %}
                    </ul>
                </li>
                {% endfor %}
            </ul>
        </li>
        {% endfor %}
    </ul>
</div>


<script type="text/javascript">
	var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
    

	var ws_path = ws_scheme + '://' + window.location.host + "/lobby_master_asgi/{{lobby_name}}/"; 
    var master_socket = new WebSocket(ws_path);

    const ul_control = document.getElementById('ul_master')
    

    function update_data() {
        master_socket.send(JSON.stringify({
            "command": "get_update",
            "lobby_name": '{{lobby_name}}',
        }))
    }

    master_socket.onopen = function(e) {
        setTimeout(update_data, 2000) 
    }


    var dict = []
    {% for i in players %}
    dict.push({{i}})
    {% endfor %}
    master_socket.onmessage = function(message) {
        var data = JSON.parse(message.data);
        if (data.update_data) {
            content = data.update_data
            console.log(content)
            for (let i=0; i<content[0].length; i++) {
                let player_card = ul_control.children[dict.indexOf(content[0][i][0]) +1]
                player_card.children[0].children[content[0][i][1]].textContent = content[0][i][2]
            }
            for (let i=0; i<content[1].length; i++) {
                let player_card = ul_control.children[dict.indexOf(content[1][i][0]) +1]
                let item_id = player_card.children[1].children.length
                player_card.children[1].appendChild(document.createElement("li"))
                player_card.children[1].children[item_id].appendChild(document.createElement("div"))
                player_card.children[1].children[item_id].appendChild(document.createElement("div"))
                player_card.children[1].children[item_id].appendChild(document.createElement("ul"))
                player_card.children[1].children[item_id].children[0].textContent = "⁣"
                player_card.children[1].children[item_id].children[1].textContent = "⁣"
            }
            for (let i=0; i<content[2].length; i++) {
                let player_card = ul_control.children[dict.indexOf(content[2][i][0]) +1]
                let item_id = content[2][i][1]
                player_card.children[1].children[item_id].children[0].textContent = content[2][i][2]+"⁣"
            }
            for (let i=0; i<content[3].length; i++) {
                let player_card = ul_control.children[dict.indexOf(content[3][i][0]) +1]
                let item_id = content[3][i][1]
                player_card.children[1].children[item_id].children[1].textContent = content[3][i][2]+"⁣"
            }
            for (let i=0; i<content[4].length; i++) {
                let player_card = ul_control.children[dict.indexOf(content[4][i][0]) +1]
                player_card.children[1].removeChild(player_card.children[1].children[content[4][i][1]])
                
            }
            for (let i=0; i<content[5].length; i++) {
                let player_card = ul_control.children[dict.indexOf(content[5][i][0]) +1]
                let modifier = player_card.children[1].children[content[5][i][1]].children[2].appendChild(document.createElement("li"))
                modifier.textContent = "⁣"
            }
            for (let i=0; i<content[6].length; i++) {
                let player_card = ul_control.children[dict.indexOf(content[6][i][0]) +1]
                player_card.children[1].children[content[6][i][1]].children[2].children[content[6][i][2]].textContent = content[6][i][3] + "⁣"
            }
            for (let i=0; i<content[7].length; i++) {
                let player_card = ul_control.children[dict.indexOf(content[7][i][0]) +1]
                player_card.children[1].children[content[7][i][1]].children[2].removeChild(player_card.children[1].children[content[7][i][1]].children[2].children[content[7][i][2]])
            }
            setTimeout(update_data, 1000)
        }
    }
</script>


{% endblock content %}